<!doctype html>
<html>
<head>
<title>Deadbeat Escapement Simulator</title>
</head>
<body>
<h1>Deadbeat Escapement Simulator</h1>

<canvas id="canvas" width="400" height="600"></canvas>

<script src="planck.min.js"></script>
<script src="renderer.js"></script>
<script src="escapewheel.js"></script>
<script src="anchor.js"></script>

<script type="text/javascript">
    const { World, Vec2, Box, Circle, Polygon, DistanceJoint, RevoluteJoint, Settings } = planck;
    Settings.linearSlop = 0.0005;
    Settings.lengthUnitsPerMeter = 0.1;
    const world = new World({
        gravity: Vec2(0.0, -9.81),
    });

    const renderer = new Renderer(world, 'canvas');

    let fixed = world.createBody({
        type: 'static',
        position: Vec2(0.0, 0.0),
    });

    let anchor = world.createBody({
        type: 'dynamic',
        position: Vec2(-0.01, 0.41),
        bullet: true,
    });
    addAnchorFixtures(anchor, {
        // TODO
    });
    anchor.createFixture({
        shape: new Circle(Vec2(0.0, -1.2), 0.25),
        density: 1.0,
        friction: 0.3,
    });
    anchor.setAngularVelocity(4);

    let escapeWheel = world.createBody({
        type: 'dynamic',
        position: Vec2(0.0, 0.0),
        bullet: true,
    });
    addEscapeWheelFixtures(escapeWheel, {
        teeth: 13,
        minorDiameter: 0.4,
        majorDiameter: 0.55,
        leadingAngle: 5,
        trailingAngle: 8,
        density: 0.1,
        friction: 0.3,
    });

    let pendulumJoint = world.createJoint(new RevoluteJoint({}, anchor, fixed, anchor.getPosition()));
    let escapeWheelJoint = world.createJoint(new RevoluteJoint({
        maxMotorTorque: 0.1, // ??
        motorSpeed: -3, // rads/sec
        enableMotor: true,
    }, fixed, escapeWheel, escapeWheel.getPosition()));

</script>
</body>
</html>
